<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='home.css') }}">
    <title>IceBackUp</title>
</head>
<body>
    <section>
        <h1>Bienvenidos al proyecto de instrumentación Industrial</h1>
    </section>

    <!-- Formulario para setpoints -->
    <section>
        <form method="POST">
            <label>
                Set Temp: <input type="number" name="setTemp" value="{{ setTemp }}">
            </label>
            <label>
                Set Nivel: <input type="number" name="setNivel" value="{{ setNivel }}">
            </label>
            <button type="submit">Actualizar</button>
        </form>
    </section>

    <section>
        <h3>Lecturas de Temperatura</h3>
        <div id="temperaturas"></div>
    </section>
    
    <!-- Tabla de registros -->
    <section>
        <div style="height:400px; overflow-y:auto; border:1px solid #ccc;">
            <table border="1" style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr>
                        {% if registros and registros[0] %}
                            {% for columna in registros[0].keys() %}
                                <th>{{ columna }}</th>
                            {% endfor %}
                        {% else %}
                            <th>ID</th>
                            <th>Temperatura</th>
                            <th>Caudal</th>
                            <th>Nivel</th>
                            <th>Posicion</th>
                            <th>Paro</th>
                            <th>Finalizado</th>
                            <th>Fecha</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="tabla-body">
                    {% if registros %}
                        {% for registro in registros %}
                            <tr>
                                {% for valor in registro.values() %}
                                    <td>{{ valor }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" style="text-align:center;">No hay registros disponibles</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </section>

    <script>
        function cargarDatos() {
            fetch('/datos')
                .then(res => res.json())
                .then(data => {
                    let tbody = document.getElementById("tabla-body");
                    tbody.innerHTML = "";
                    data.forEach(row => {
                        let tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td>${row.id}</td>
                            <td>${row.temperatura}</td>
                            <td>${row.caudal}</td>
                            <td>${row.nivel}</td>
                            <td>${row.posicion}</td>
                            <td>${row.paro}</td>
                            <td>${row.finalizado}</td>
                            <td>${row.fecha}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
        }

        // actualizar cada 2 segundos
        setInterval(cargarDatos, 500);
    </script>

    <script>
function actualizarUltimaTemperatura() {
    fetch('/datos')
        .then(res => res.json())
        .then(data => {
            let divTemp = document.getElementById("temperaturas");
            divTemp.innerHTML = ""; // limpiar contenido

            if (data.length === 0) {
                divTemp.textContent = "No hay datos disponibles";
                return;
            }

            // Tomar solo el primer registro (el más reciente)
            let ultimo = data[0];
            divTemp.textContent = `Última temperatura: ${ultimo.temperatura} °C (Registro ${ultimo.id})`;
        });
}

// Actualizar cada 2 segundos
setInterval(actualizarUltimaTemperatura, 500);
actualizarUltimaTemperatura();
</script>

</body>
</html>
